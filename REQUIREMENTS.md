# Gmail添付ファイルをGoogleドライブにコピーするツール

## 要件定義

### 1. プロジェクト概要

Gmailから指定期間のメール内にあるPDF添付ファイルを抽出し、Google ドライブの指定フォルダに一括でコピーするGoogle Apps Script ツール。

UI環境として、Google Sheetのカスタムメニューから実行でき、検索条件入力シート（UI）と結果表示シート（出力）で構成される。

---

## 2. 機能要件

### 2.1 ユーザーインターフェース

#### 2.1.1 検索条件入力シート（「検索条件」シート）

以下の入力欄を備える：

| 項目                   | 入力形式   | 必須/任意 | 説明                                                                                      |
| ---------------------- | ---------- | --------- | ----------------------------------------------------------------------------------------- |
| **期間（開始日）**     | YYYY-MM-DD | 必須      | 検索対象メールの開始日                                                                    |
| **期間（終了日）**     | YYYY-MM-DD | 必須      | 検索対象メールの終了日                                                                    |
| **フィルタ文字列**     | テキスト   | 任意      | メールタイトルで部分一致検索するキーワード（複数入力の場合はカンマ区切り）                |
| **保存先フォルダパス** | パス文字列 | 必須      | Googleドライブ内の保存先（例：`/プロジェクト/PDFフォルダ` または `/年度別/2026年度/1月`） |

**UI操作**：

- Google Sheetのカスタムメニュー「Gmail添付ファイル」→「検索して一覧表示」を実行
- GASスクリプトが検索条件を読み込み、結果表示シートに候補を表示

#### 2.1.2 結果表示シート（「結果」シート）

以下の列で構成される：

| 列                   | 内容                     | 詳細                                                                                             |
| -------------------- | ------------------------ | ------------------------------------------------------------------------------------------------ |
| **保存対象**         | チェックボックス         | ユーザーが保存する/しないを選択（初期値は全てON）                                                |
| **メールタイトル**   | テキスト                 | 検索結果に含まれるメール件名                                                                     |
| **受信日時**         | 日時                     | メール受信日時（YYYY-MM-DD HH:MM:SS形式）                                                        |
| **添付ファイル名**   | テキスト（カンマ区切り） | 該当メール内のPDF添付ファイル名（複数の場合は全て表示）                                          |
| **保存ファイル名**   | テキスト                 | Googleドライブに保存する際のファイル名（任意入力。空欄の場合は元のPDFファイル名を使用）          |
| **保存先フォルダ名** | テキスト                 | 保存先フォルダパス（初期値は「検索条件」シートで指定されたパス。ユーザーがメールごとに変更可能） |
| **処理結果**         | テキスト                 | 実行後に「OK」「SKIP」「エラー」など結果を表示                                                   |
| **ファイルリンク**   | ハイパーリンク           | 「OK」の場合、保存されたファイルへのGoogleドライブのリンクを自動生成                             |

**UI操作**：

- ユーザーは「保存対象」チェックボックスで処理対象を絞り込み
- 「保存ファイル名」「保存先フォルダ名」をカスタマイズ可能
- カスタムメニュー「Gmail添付ファイル」→「選択対象をGoogleドライブにコピー」を実行

---

### 2.2 検索・フィルタ機能

#### 2.2.1 期間フィルタ

- 開始日時と終了日時の間に受信されたメール（終了日は23:59:59まで包含）
- 無効な日付入力はエラーメッセージで通知

#### 2.2.2 キーワードフィルタ

- メールタイトル（件名）に対する部分一致検索
- 複数キーワード指定の場合は、いずれかに合致するメールを表示（OR条件）
- 未指定の場合は全メール対象

#### 2.2.3 添付ファイルフィルタ

- **必須フィルタ**：PDF ファイルのみを対象（拡張子 .pdf）
- PDF以外の添付ファイルは無視される

---

### 2.3 処理フロー（実行）

#### 2.3.1 検索フェーズ（「検索して一覧表示」実行時）

1. 検索条件シートから入力値を取得
2. Gmailの`search()` メソッドでメールスレッドを検索
   - 条件：`is:attachment after:開始日 before:終了日+1`
3. 該当スレッド内のメール＆添付ファイルを取得
4. 各メールについて：
   - タイトル
   - 受信日時
   - PDF添付ファイル一覧
     を抽出
5. 結果表示シートにデータを書き込み
6. 完了メッセージを表示

#### 2.3.2 実行フェーズ（「選択対象をGoogleドライブにコピー」実行時）

1. 結果表示シートから「保存対象」がONのRow を抽出
2. 各メールについて：
   - 添付ファイルを取得
   - 保存先フォルダパスを解析して、フォルダIDに変換
   - フォルダが存在しなければ新規作成
   - ファイルを保存先フォルダに配置
   - ファイル名が既に存在するか確認
     - **存在する場合**：スキップ、処理結果に「SKIP：ファイル名が既に存在します」と表示
     - **存在しない場合**：ファイルをコピーして、処理結果に「OK」と表示
   - 「OK」の場合、ファイルリンク列に保存ファイルへのリンクを自動生成

---

### 2.4 フォルダパス処理仕様

#### 2.4.1 パス解析

- パスは `/` で区切られたGoogle Drive 内のフォルダパス
- 例：`/プロジェクト/PDFフォルダ` → `/プロジェクト` → `/PDFフォルダ`
- 相対パス（`/` で開始）をサポート

#### 2.4.2 フォルダの自動作成

- 指定パスが存在しない場合、自動的に新規作成
- 親フォルダが存在しない場合も、再帰的に親フォルダから作成

#### 2.4.3 ルートフォルダ

- `/` 単体または空欄の場合は「My Drive」をルートフォルダとして扱う

---

### 2.5 ファイル名・リンク処理仕様

#### 2.5.1 保存ファイル名の決定

```
if 「保存ファイル名」列に値がある:
    使用するファイル名 = 入力されたファイル名
else:
    使用するファイル名 = 元の添付PDFファイル名
```

#### 2.5.2 ファイル拡張子

- 保存ファイル名に `.pdf` 拡張子がなければ自動付与

#### 2.5.3 ファイルリンク生成

- 保存後、生成されたファイルのGoogle Drive リンクを自動生成
- リンク形式：`https://drive.google.com/file/d/{fileId}/view`
- 結果表示シートの「ファイルリンク」列にハイパーリンクとして埋め込み

---

## 3. 非機能要件

### 3.1 エラーハンドリング

| エラー状況            | 対応                                                                     |
| --------------------- | ------------------------------------------------------------------------ |
| 無効な日付入力        | エラーダイアログを表示、処理中止                                         |
| Gmail API呼び出し失敗 | エラーメッセージを表示、スタックトレース記録（デバッグ用）               |
| フォルダ作成失敗      | 当該メールの結果に「エラー：フォルダ作成失敗」と表示、次のメールに続行   |
| ファイルコピー失敗    | 当該メールの結果に「エラー：ファイルコピー失敗」と表示、次のメールに続行 |

### 3.2 パフォーマンス

- 検索件数が多い場合（100件以上）、実行時間が長くなることが想定される
- 処理中はログをコンソールに出力して進捗を監視可能

### 3.3 セキュリティ

- GmailAPI・ Sheets API・Drive APIへのスコープ要求
- トリガー権限：ユーザーの手動実行のみ（自動実行なし）

### 3.4 その他

- **ログ出力**：不要（結果表示シートに処理結果を記載）
- **同時実行制御**：スクリプト実行中の多重実行防止機構は不要

---

## 4. 技術仕様

### 4.1 実装環境

- **プラットフォーム**：Google Apps Script（GAS）
- **テスト環境**：Google Sheets + Gmail
- **言語**：JavaScript（GAS）

### 4.2 必要なAPI

- **Gmail API**
  - `search()`：メール検索
  - `getAttachments()`：添付ファイル取得
- **Google Sheets API**
  - `getRange()`，`setValues()`：シート読み書き

- **Google Drive API**
  - `getFoldersByName()`，`createFolder()`：フォルダ管理
  - `getFilesByName()`，`createFile()`：ファイル管理

### 4.3 スコープ

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/gmail.readonly",
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive"
  ]
}
```

---

## 5. 成功基準

- ✅ 指定期間のメールから PDF 添付ファイルを正確に抽出
- ✅ メールタイトルでキーワード検索が機能
- ✅ 結果表示シートにメールメタ情報と添付ファイル名が表示
- ✅ ユーザーが保存対象を選択・カスタマイズ可能
- ✅ 指定されたフォルダパスにファイルを正確に保存
- ✅ フォルダが自動作成される
- ✅ ファイル名重複時にスキップ・アラート表示される
- ✅ 処理結果（OK/SKIP/エラー）が明確に表示される
- ✅ OK時にファイルリンクが自動生成される

---
