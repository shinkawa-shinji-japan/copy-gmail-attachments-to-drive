# セットアップ・デプロイガイド

## 1. 初期セットアップ

### 1.1 前提条件

- Google アカウント
- Google Drive アクセス可能な環境
- Node.js 18以上がインストール済み
- clasp がインストール済み（グローバル）

```bash
npm install -g @google/clasp
```

### 1.2 Google Apps Script プロジェクトの作成

まず、Google Apps Script プロジェクトを作成する必要があります。

#### 方法1：Google Sheets から直接作成（推奨）

1. **Google Sheets を開く**
   - [Google Drive](https://drive.google.com) にアクセス
   - 「新規」→「Google Sheets」→「空のスプレッドシート」を選択
   - スプレッドシートに任意の名前を付ける（例：「Gmail添付ファイルコピー」）

2. **Google Apps Script エディタを開く**
   - メニューから「拡張機能」→「Apps Script」をクリック
   - Google Apps Script エディタが開きます

3. **コードをコピー＆ペースト**
   - 本リポジトリの `src/` フォルダ内の各ファイル（`.gs`）の内容をコピー
   - Google Apps Script エディタの対応するファイルに貼り付け
   - または下記「方法2」でコマンドからアップロード

#### 方法2：clasp でプロジェクトをリンク（既存プロジェクト）

Google Apps Script プロジェクトを既に持っている場合：

1. **プロジェクトIDを取得**
   - Google Apps Script エディタで「プロジェクト設定」をクリック
   - 「スクリプトID」をコピー

2. **claspを認証**

   ```bash
   cd copy-gmail-attachments-to-drive
   clasp login
   ```

   - ブラウザが開き、Google Account でログイン
   - 指示に従い認証を完了

3. **プロジェクトをリンク**

   ```bash
   clasp clone <スクリプトID>
   ```

4. **コードをプッシュ**
   ```bash
   npm run push
   ```

---

## 2. 初回使用時の手順

### 2.1 スプレッドシートの初期化

1. Google Sheets を開く
2. 画面上のメニューに「Gmail添付ファイル」が表示されます
3. 「Gmail添付ファイル」→「初期化（シート作成）」を実行

**実行結果：**

- 「検索条件」シートが自動作成（検索条件を入力するシート）
- 「結果」シートが自動作成（検索結果とファイルコピー結果を表示するシート）

### 2.2 検索条件を入力

「検索条件」シートで以下を入力：

| 項目                   | 入力例                    | 説明                                                       |
| ---------------------- | ------------------------- | ---------------------------------------------------------- |
| **期間（開始日）**     | 2026-01-01                | 検索対象の開始日（YYYY-MM-DD形式）                         |
| **期間（終了日）**     | 2026-01-31                | 検索対象の終了日（YYYY-MM-DD形式）                         |
| **フィルタ文字列**     | 請求書, 報告書            | キーワード（複数の場合はカンマ区切り、空白可）             |
| **保存先フォルダパス** | /プロジェクト/PDFフォルダ | Google Drive内のフォルダパス（フォルダが無ければ自動作成） |

**パスの記法：**

- 相対パス：`/フォルダA/フォルダB` → My Drive 内の「フォルダA」→「フォルダB」
- ルート指定：`/` または空欄 → My Drive 直下

### 2.3 メールを検索

1. 「Gmail添付ファイル」→「検索して一覧表示」を実行
2. 検索結果が「結果」シートに表示
3. 以下の情報が表示：
   - メールタイトル
   - 受信日時
   - 添付PDF ファイル名

### 2.4 保存対象を確認・カスタマイズ

「結果」シートで以下をカスタマイズ：

| 列                   | 説明                                                  |
| -------------------- | ----------------------------------------------------- |
| **保存対象**         | チェックボックス。保存する場合はON                    |
| **保存ファイル名**   | 保存時のファイル名（空欄なら元のPDFファイル名を使用） |
| **保存先フォルダ名** | 保存先フォルダパス（初期値は検索条件で指定したパス）  |

### 2.5 ファイルをコピー

1. 「Gmail添付ファイル」→「選択対象をGoogleドライブにコピー」を実行
2. 処理結果が「結果」シートに表示：
   - **OK**：ファイルが正常にコピーされた（リンク付き）
   - **SKIP：ファイルが既に存在**：同名ファイルがフォルダに既に存在
   - **エラー**：その他のエラーが発生

---

## 3. clasp コマンドリファレンス

```bash
# 認証
clasp login

# コードを Google Apps Script にプッシュ
npm run push

# Google Apps Script からコードをプル
npm run pull

# Google Apps Script エディタをブラウザで開く
npm run open

# ログを表示
npm run logs

# 本番デプロイ（バージョン付き）
npm run deploy

# バージョンを表示
npm run version
```

---

## 4. トラブルシューティング

### 問題1：「Gmail添付ファイル」メニューが表示されない

**原因：** スクリプトの権限設定が完了していない

**解決方法：**

1. Google Apps Script エディタを開く
2. 「初期化（シート作成）」関数を実行
3. 権限ダイアログが表示されたら「許可」をクリック
4. Google Sheets に戻ってリロード

### 問題2：「検索条件シートが見つかりません」エラー

**原因：** 初期化処理が実行されていない

**解決方法：**

1. 「Gmail添付ファイル」→「初期化（シート作成）」を実行

### 問題3：検索結果が0件

**原因：** 指定期間にPDF付きメールが存在しない

**解決方法：**

1. 検索条件シートの日付範囲を拡張
2. フィルタ文字列を削除またはキーワードを変更

### 問題4：ファイルコピーが失敗する

**原因：** 以下が考えられます

- フォルダパスが不正
- Google Drive のクォータ超過
- 権限不足

**解決方法：**

1. フォルダパスを確認（スペースを含めた正確な名称）
2. Google Drive の残容量を確認
3. Google Apps Script エディタで「実行ログを表示」してエラー詳細を確認

---

## 5. ローカル開発フロー

### 5.1 ソースコードの編集

```bash
# src/ フォルダ内のファイルを編集
# 例：src/main.gs, src/gmail.gs など
```

### 5.2 Google Apps Script にプッシュ

```bash
npm run push
```

### 5.3 ブラウザで実行・確認

```bash
npm run open
```

### 5.4 ログを確認

```bash
npm run logs
```

---

## 6. プロジェクト構成

```
copy-gmail-attachments-to-drive/
├── src/
│   ├── main.gs          # メイン処理・UI制御
│   ├── gmail.gs         # Gmail API ラッパー
│   ├── drive.gs         # Google Drive API ラッパー
│   ├── sheet.gs         # Google Sheets ラッパー
│   └── utils.gs         # ユーティリティ関数
├── appsscript.json      # GAS マニフェスト
├── package.json         # Node.js パッケージ定義
├── REQUIREMENTS.md      # 要件定義
├── IMPLEMENTATION_PLAN.md  # 実装方針
└── SETUP_GUIDE.md       # このファイル
```

---

## 7. セキュリティ・プライバシー

このスクリプトは以下のGoogleサービスにアクセスします：

- **Gmail（読み取り専用）**：メール検索と添付ファイル取得
- **Google Drive**：フォルダ・ファイル操作
- **Google Sheets**：スプレッドシートのシート管理

すべてのアクセスはユーザーの明示的な認可に基づいています。

---

## 8. 更新・メンテナンス

### コードの更新

```bash
# リモートコード（Google Apps Script）をプル
npm run pull

# ローカルで編集
# 編集後、プッシュ
npm run push
```

### 本番デプロイ

```bash
# バージョンを指定してデプロイ
npm run deploy
```

---

## 9. ご質問・バグ報告

問題や質問がある場合は、GitHub Issues で報告してください。
